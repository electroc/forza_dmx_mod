
#include <TeensyDMX.h>
#include <elapsedMillis.h>
#include <Flash.h>

#define KW_PIN 17
#define WW_PIN 16

#define FAN_PIN 5

namespace teensydmx = ::qindesign::teensydmx;

teensydmx::Receiver dmxRx{Serial1};

elapsedMillis timeOutElapsed;
elapsedMillis timeInElapsed;

unsigned int fan_time_in   =  3000;
unsigned int fan_time_out  =  3000;


unsigned int pwm_freq      =  20000;
byte pwm_resolution        =     12;
byte fan_threshold         =     80;
unsigned int dmx_start_adr =     1;

uint8_t dmx_dimm           =     0;
uint8_t dmx_fade           =     0;

uint8_t last_dmx_dimm           =     0;
uint8_t last_dmx_fade           =     0;


uint8_t fade_invert        =     0;
uint8_t dimm_invert        =     0;

int fade1                  =     0;
int fade2                  =     0;
float quotient;

unsigned int fadex         =     0;
unsigned int fadey         =     0;

unsigned int fadex_new         =     0;
unsigned int fadey_new         =     0;


bool fan_on             = false;
bool fan_off            = false;
bool fan_is_on          = false;

uint8_t x                     =     0;

bool odd                = false;

//FLASH_ARRAY(unsigned int, pwmTable_W,0,6,6,7,7,8,8,9,9,10,10,10,11,11,11,12,12,12,12,13,13,13,14,14,14,15,15,15,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,27,27,28,29,29,30,31,31,32,33,34,35,36,36,37,38,39,40,41,42,43,44,45,47,48,49,50,51,53,54,55,57,58,59,61,62,64,66,67,69,71,72,74,76,78,80,82,84,86,88,90,92,95,97,99,102,104,107,110,112,115,118,121,124,127,130,133,137,140,143,147,151,154,158,162,166,170,174,179,183,188,192,197,202,207,212,217,223,228,234,240,246,252,258,264,271,278,285,292,299,306,314,322,330,338,346,355,363,372,382,391,401,411,421,431,442,453,464,476,487,500,512,525,538,551,565,579,593,608,623,638,654,670,687,704,721,739,757,776,795,815,835,856,877,899,921,944,967,991,1015,1041,1066,1093,1120,1148,1176,1205,1235,1266,1297,1329,1362,1396,1430,1466,1502,1539,1577,1616,1656,1697,1739,1783,1827,1872,1918,1966,2014,2064,2115,2168,2222,2277,2333,2391,2450,2511,2573,2636,2702,2769,2837,2907,2979,3053,3129,3206,3286,3367,3451,3536,3624,3713,3805,3899,3996,4095);
//FLASH_ARRAY(unsigned int, pwmTable2047,0,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,6,6,6,6,6,6,7,7,7,7,7,8,8,8,8,9,9,9,9,10,10,10,11,11,11,12,12,12,13,13,14,14,14,15,15,16,16,17,17,18,18,19,19,20,20,21,22,22,23,24,24,25,26,27,27,28,29,30,31,32,33,34,35,36,37,38,39,40,42,43,44,45,47,48,50,51,53,54,56,58,59,61,63,65,67,69,71,73,75,77,80,82,84,87,90,92,95,98,101,104,107,110,113,117,120,124,128,131,135,139,144,148,152,157,162,166,171,177,182,187,193,199,205,211,217,224,230,237,244,252,259,267,275,283,292,300,309,319,328,338,348,359,369,381,392,404,416,428,441,454,468,482,496,511,527,542,559,575,593,610,629,647,667,687,707,729,750,773,796,820,845,870,896,923,950,979,1008,1038,1070,1102,1135,1169,1204,1240,1277,1315,1355,1395,1437,1480,1524,1570,1617,1666,1715,1767,1820,1874,1931,2047);
//FLASH_ARRAY(unsigned int, pwmTable2047,0,1,1,1,1,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,10,10,10,10,11,11,11,12,12,12,13,13,13,14,14,15,15,15,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,24,24,25,26,26,27,28,29,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,46,47,48,49,51,52,54,55,57,58,60,61,63,65,67,69,70,72,74,76,78,81,83,85,87,90,92,95,98,100,103,106,109,112,115,118,121,125,128,132,135,139,143,147,151,155,159,163,168,173,177,182,187,192,198,203,209,215,220,227,233,239,246,253,260,267,274,282,289,297,305,314,323,331,341,350,360,369,380,390,401,412,423,435,447,459,472,485,498,512,526,541,556,571,587,603,619,636,654,672,690,709,729,749,770,791,813,835,858,882,906,931,957,983,1010,1038,1067,1096,1126,1157,1189,1222,1256,1290,1326,1362,1400,1438,1478,1519,1561,1604,1648,1693,1740,1788,1837,1888,1940,1993,2000);
//FLASH_ARRAY(unsigned int, pwmTable2047,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,5,5,5,5,5,5,6,6,6,6,7,7,7,7,7,8,8,8,9,9,9,9,10,10,10,11,11,11,12,12,13,13,13,14,14,15,15,16,16,17,17,18,18,19,20,20,21,22,22,23,24,24,25,26,27,28,29,29,30,31,32,33,34,35,36,38,39,40,41,42,44,45,46,48,49,51,52,54,56,57,59,61,63,65,67,69,71,73,75,78,80,82,85,88,90,93,96,99,102,105,108,111,115,118,122,125,129,133,137,141,146,150,155,159,164,169,174,180,185,191,196,202,209,215,221,228,235,242,249,257,265,273,281,289,298,307,316,326,336,346,357,367,378,390,402,414,426,439,452,466,480,495,510,525,541,557,574,591,609,628,646,666,686,707,728,750,773,796,820,845,870,897,924,951,980,1010,1040,1072,1104,1137,1172,1207,1243,1281,1319,1359,1400,1442,1486,1531,1577,1624,1673,1724,1776,1829,1885,1941,2000);
//FLASH_ARRAY(unsigned int, pwmTable2047,0,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,6,6,7,7,7,7,7,8,8,8,8,8,9,9,9,9,10,10,10,10,11,11,11,11,12,12,12,13,13,13,14,14,14,15,15,16,16,17,17,17,18,18,19,19,20,20,21,21,22,23,23,24,25,25,26,27,27,28,29,29,30,31,32,33,34,34,35,36,37,38,39,40,41,43,44,45,46,47,49,50,51,53,54,55,57,58,60,62,63,65,67,68,70,72,74,76,78,80,82,84,87,89,91,94,96,99,101,104,107,110,113,116,119,122,125,129,132,135,139,143,147,150,154,159,163,167,172,176,181,186,191,196,201,206,212,217,223,229,235,242,248,255,261,268,276,283,290,298,306,314,323,331,340,349,358,368,378,388,398,409,420,431,442,454,466,479,491,505,518,532,546,561,576,591,607,623,639,656,674,692,710,729,749,769,789,810,832,854,877,900);
//FLASH_ARRAY(unsigned int, pwmTable2047,0,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,7,7,7,7,7,7,8,8,8,8,8,9,9,9,9,9,10,10,10,10,11,11,11,11,12,12,12,13,13,13,14,14,14,15,15,15,16,16,16,17,17,18,18,19,19,19,20,20,21,21,22,22,23,24,24,25,25,26,27,27,28,29,29,30,31,31,32,33,34,35,35,36,37,38,39,40,41,42,43,44,45,46,47,48,50,51,52,53,55,56,57,59,60,62,63,65,66,68,69,71,73,74,76,78,80,82,84,86,88,90,92,95,97,99,102,104,107,109,112,115,117,120,123,126,129,132,136,139,142,146,149,153,157,160,164,168,172,176,181,185,190,194,199,204,209,214,219,224,230,235,241,247,253,259,265,272,278,285,292,299,306,314,321,329,337,345,354,362,371,380,389,399,408,418,428,439,449,460,471,483,494,506,519,531,544,557,571,585,599,613,628,644,659,675,691,708,725,743,761,779,798,818,838,858,879,900);
//FLASH_ARRAY(unsigned int, pwmTable,0,141,141,141,141,142,142,142,142,142,142,143,143,143,143,143,143,143,143,143,143,143,144,144,144,144,144,144,144,144,144,145,145,145,145,145,145,146,146,146,146,146,146,147,147,147,147,147,148,148,148,148,149,149,149,150,150,150,150,151,151,151,152,152,152,153,153,154,154,155,155,155,156,156,157,157,158,158,159,160,160,161,161,162,163,163,164,165,166,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,183,184,185,187,188,190,191,193,194,196,198,199,201,203,205,207,209,211,213,216,218,220,223,225,228,230,233,236,239,242,245,248,252,255,259,262,266,270,274,278,282,286,291,295,300,305,310,315,320,326,332,338,344,350,356,363,369,376,384,391,399,407,415,423,432,441,450,459,469,479,489,500,511,522,534,546,558,571,584,598,612,626,641,656,672,688,705,722,740,758,777,796,816,837,858,880,902,926,950,974,1000,1026,1053,1081,1109,1139,1169,1201,1233,1266,1301,1336,1373,1410,1449,1489,1530,1572,1616,1661,1707,1755,1804,1855,1907,1961,2016,2074,2132,2193,2256,2320,2387,2455,2526,2598,2673,2750,2830,2912,2996,3083,3173,3266,3361,3459,3560,3664,3772,3882,3996);
//FLASH_ARRAY(unsigned int, pwmTable,0,140,140,140,141,141,141,141,141,141,141,141,141,141,141,141,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,143,143,143,143,143,143,143,143,143,143,144,144,144,144,144,144,144,144,145,145,145,145,145,145,146,146,146,146,146,147,147,147,147,147,148,148,148,148,149,149,149,150,150,150,151,151,151,152,152,153,153,153,154,154,155,155,156,156,157,157,158,159,159,160,160,161,162,163,163,164,165,166,167,167,168,169,170,171,172,173,175,176,177,178,179,181,182,183,185,186,188,190,191,193,195,196,198,200,202,204,206,209,211,213,216,218,221,224,226,229,232,235,238,242,245,249,252,256,260,264,268,272,276,281,286,291,296,301,306,312,317,323,329,336,342,349,356,363,370,378,386,394,402,411,420,430,439,449,459,470,481,492,504,516,529,542,555,569,583,598,613,629,645,662,679,697,715,735,754,775,796,818,840,863,888,912,938,965,992,1020,1050,1080,1111,1143,1177,1211,1247,1284,1322,1361,1402,1443,1487,1532,1578,1626,1675,1726,1779,1833,1890,1948,2008,2070,2134,2200,2269,2340,2413,2488,2567,2647,2731,2817,2906,2998,3093,3191,3292,3397,3505,3617,3733,3852,3976);
//FLASH_ARRAY(unsigned int, pwmTable,0,140,140,141,141,142,143,144,145,145,146,147,148,149,151,152,153,154,155,156,157,158,160,161,162,163,165,166,167,168,170,171,173,174,176,177,179,180,182,183,185,187,188,190,192,194,195,197,199,201,203,205,207,209,211,213,215,218,220,222,224,227,229,232,234,237,239,242,244,247,250,253,255,258,261,264,267,270,274,277,280,283,287,290,294,297,301,305,308,312,316,320,324,328,332,337,341,345,350,354,359,364,368,373,378,383,388,394,399,404,410,415,421,427,433,439,445,451,457,464,470,477,484,491,498,505,512,520,527,535,542,550,558,567,575,583,592,601,610,619,628,638,647,657,667,677,687,698,708,719,730,741,753,764,776,788,800,813,825,838,851,865,878,892,906,920,935,950,965,980,996,1011,1028,1044,1061,1078,1095,1112,1130,1149,1167,1186,1205,1225,1244,1265,1285,1306,1327,1349,1371,1393,1416,1439,1463,1487,1512,1536,1562,1587,1614,1640,1667,1695,1723,1752,1781,1810,1840,1871,1902,1934,1966,1999,2032,2066,2101,2136,2172,2208,2245,2283,2322,2361,2400,2441,2482,2524,2566,2610,2654,2699,2744,2791,2838,2886,2935,2985,3035,3087,3139,3193,3247,3302,3358,3416,3474,3533,3593,3654,3717,3780,3845,3911,3977,4045);
//FLASH_ARRAY(unsigned int, pwmTable,0,141,142,144,146,148,150,152,154,156,158,160,162,164,166,169,171,173,175,178,180,183,185,188,190,193,195,198,200,203,206,209,211,214,217,220,223,226,229,232,235,238,241,245,248,251,255,258,261,265,269,272,276,279,283,287,291,295,299,303,307,311,315,319,323,328,332,337,341,346,350,355,360,365,369,374,379,384,390,395,400,405,411,416,422,428,433,439,445,451,457,463,469,476,482,488,495,501,508,515,522,529,536,543,550,558,565,573,580,588,596,604,612,620,629,637,646,654,663,672,681,690,699,708,718,728,737,747,757,767,778,788,799,809,820,831,842,853,865,876,888,900,912,924,937,949,962,975,988,1001,1014,1028,1042,1056,1070,1084,1099,1113,1128,1143,1159,1174,1190,1206,1222,1238,1255,1271,1288,1306,1323,1341,1359,1377,1395,1414,1433,1452,1472,1491,1511,1531,1552,1573,1594,1615,1637,1659,1681,1703,1726,1749,1773,1796,1820,1845,1869,1894,1920,1945,1971,1998,2025,2052,2079,2107,2135,2164,2193,2222,2252,2282,2312,2343,2375,2406,2439,2471,2504,2538,2572,2606,2641,2676,2712,2748,2785,2822,2860,2899,2937,2977,3016,3057,3098,3139,3181,3224,3267,3311,3355,3400,3445,3491,3538,3585,3633,3682,3731,3781,3832,3883,3935,3988,4041,4095);
//FLASH_ARRAY(unsigned int, pwmTable,0,135,140,145,150,155,160,165,170,175,180,186,191,196,202,207,212,218,223,229,234,240,246,251,257,263,269,275,280,286,292,298,304,311,317,323,329,335,342,348,355,361,367,374,381,387,394,401,407,414,421,428,435,442,449,456,463,471,478,485,492,500,507,515,522,530,538,545,553,561,569,577,585,593,601,609,618,626,634,643,651,660,668,677,685,694,703,712,721,730,739,748,757,767,776,785,795,804,814,824,833,843,853,863,873,883,893,903,914,924,934,945,955,966,977,988,998,1009,1020,1031,1043,1054,1065,1077,1088,1100,1111,1123,1135,1147,1159,1171,1183,1195,1208,1220,1232,1245,1258,1270,1283,1296,1309,1322,1336,1349,1362,1376,1389,1403,1417,1431,1445,1459,1473,1487,1501,1516,1530,1545,1560,1575,1590,1605,1620,1635,1651,1666,1682,1697,1713,1729,1745,1761,1778,1794,1811,1827,1844,1861,1878,1895,1912,1929,1947,1964,1982,2000,2018,2036,2054,2072,2091,2109,2128,2147,2166,2185,2204,2223,2243,2263,2282,2302,2322,2342,2363,2383,2404,2425,2446,2467,2488,2509,2531,2552,2574,2596,2618,2640,2663,2685,2708,2731,2754,2777,2800,2824,2848,2871,2896,2920,2944,2969,2993,3018,3043,3068,3094,3119,3145,3171,3197,3223,3250,3277,3303,3330,3358,3385,3413,3440,3468,3497,3525,3554);
FLASH_ARRAY(unsigned int, pwmTable,100,135,140,146,151,156,161,167,172,178,183,189,194,200,206,211,217,223,229,235,240,246,252,258,265,271,277,283,289,296,302,308,315,321,328,335,341,348,355,361,368,375,382,389,396,403,411,418,425,432,440,447,455,462,470,477,485,493,501,508,516,524,532,541,549,557,565,574,582,590,599,608,616,625,634,643,652,660,670,679,688,697,706,716,725,735,744,754,764,774,783,793,803,814,824,834,844,855,865,876,886,897,908,919,930,941,952,963,974,986,997,1009,1020,1032,1044,1055,1067,1079,1092,1104,1116,1129,1141,1154,1166,1179,1192,1205,1218,1231,1244,1258,1271,1285,1298,1312,1326,1340,1354,1368,1382,1397,1411,1426,1440,1455,1470,1485,1500,1515,1531,1546,1562,1577,1593,1609,1625,1641,1657,1674,1690,1707,1724,1740,1757,1775,1792,1809,1827,1844,1862,1880,1898,1916,1934,1953,1971,1990,2009,2028,2047,2066,2085,2105,2125,2144,2164,2185,2205,2225,2246,2266,2287,2308,2329,2351,2372,2394,2416,2438,2460,2482,2504,2527,2550,2573,2596,2619,2643,2666,2690,2714,2738,2762,2787,2812,2837,2862,2887,2912,2938,2964,2990,3016,3042,3069,3095,3122,3150,3177,3204,3232,3260,3288,3317,3345,3374,3403,3432,3462,3491,3521,3551,3582,3612,3643,3674,3705,3736,3768,3800,3832,3865,3897,3930,3963);


void setup() {

  Serial.begin(115200);

  pinMode(FAN_PIN,OUTPUT);
  
  analogWriteResolution(pwm_resolution);
  analogWriteFrequency(KW_PIN, pwm_freq);
  analogWriteFrequency(WW_PIN, pwm_freq);

  dmxRx.begin();

  digitalWrite(FAN_PIN,HIGH);
  delay(2000);
  digitalWrite(FAN_PIN,LOW);
}


void loop() {

  odd =! odd;

  dmx_dimm = dmxRx.get(dmx_start_adr);
  dmx_fade = dmxRx.get(dmx_start_adr+1);
 
  if(dmx_dimm != last_dmx_dimm || dmx_fade != last_dmx_fade ){
      
    last_dmx_dimm = dmx_dimm;
    last_dmx_fade = dmx_fade;
 
    //dimm_invert = ~dmx_dimm;
    fade_invert = ~dmx_fade;
    
    quotient = float(dmx_dimm) / 255;
    
    fade1 = dmx_fade * quotient;     // kaltweiß 
    fade2 = fade_invert * quotient;  // warmweiß 
  
    fadex = pwmTable[fade1];
    fadey = pwmTable[fade2];
    
     
    analogWrite(KW_PIN,fadex);
    analogWrite(WW_PIN,fadey);
 }

/*
  for(int x=4;x<100;x++)
    {
      analogWrite(KW_PIN,x);
      delay(1);
    }
  for(int x=100;x>=4;x--)
    {
      analogWrite(KW_PIN,x);
      delay(1);
    }  
*/  
 
  if(!fan_is_on){    
    if( (fade1+fade2) > fan_threshold && !fan_on) { 
      fan_on=true;
      timeInElapsed=0;
      //Serial.println("fan soll eingeschalten werden");
    }
    if( (fade1+fade2) < fan_threshold) fan_on=false;
    
    if(timeInElapsed > fan_time_in && fan_on){
      //Serial.println("fan ist ein");
      digitalWriteFast(FAN_PIN,HIGH);
      fan_on=false;
      fan_is_on=true;
    }
  }
  if(fan_is_on){
    if( (fade1+fade2) < fan_threshold && !fan_off){
      fan_off=true;
      timeOutElapsed=0;
      //Serial.println("fan soll ausgeschalten werden");
    }
    if( (fade1+fade2) > fan_threshold) fan_off=false;
    
    if(timeOutElapsed > fan_time_out && fan_off){
      //Serial.println("fan ist aus");
      digitalWriteFast(FAN_PIN,LOW);
      fan_off=false;
      fan_is_on=false;
    }
  }

} 
